;; パッケージ管理の初期化
(require 'package)
(add-to-list 'package-archives '("melpa" . "http://melpa.milkbox.net/packages/") t)
(add-to-list 'package-archives '("marmalade" . "http://marmalade-repo.org/packages/") t)
(package-initialize)

;; 分割した設定ファイルの読み込み
(setq load-path
      (append '(
                "~/.emacs.d/conf"
                ) load-path))

(load "golang-conf")                     ; golang 関連の別途設定ファイル




;; 日本語などの設定
(set-language-environment 'Japanese)    ; 日本語環境
(set-default-coding-systems 'utf-8-unix)    ; UTF-8 が基本
(set-terminal-coding-system 'utf-8-unix)    ; emacs -nw も文字化けしない
(setq default-file-name-coding-system 'utf-8)
(setq default-process-coding-system '(utf-8 . utf-8))
(prefer-coding-system 'utf-8-unix)


;; メニューバーを消す
(if window-system (menu-bar-mode 1) (menu-bar-mode -1))



;; ロックファイル / バックアップファイルを作成しない
(setq create-lockfiles nil)
(setq make-backup-files nil)
(setq delete-auto-save-files t)


;; 対応するカッコを強調表示
(show-paren-mode t)

;; 時間も表示させる。
(display-time)

;; 行番号を常に表示させる
(require 'linum)
(global-linum-mode t)
(setq linum-format "%4d ")
(setq linum-delay t)
(defadvice linum-schedule (around my-linum-schedule () activate)
    (run-with-idle-timer 0.2 nil #'linum-update-current))

;; gitの差分などを表示させる。
(require 'git-gutter)
(global-git-gutter-mode t)
(git-gutter:linum-setup)
(custom-set-variables
  '(git-gutter:update-interval 3))


;; 現在行を目立たせる

;; テーマを設定する
(load-theme 'manoj-dark t)

;; キーバインドの変更
(keyboard-translate ?\C-h ?\C-?)

;; Cmd をメタキーに
(when (eq system-type 'darwin)
  (setq ns-command-modifier (quote meta)))



;; ===============================================
;; helm
;; ==============================================
(require 'helm-config)
(helm-mode 1)

; C-h で前の文字を削除する。
(define-key helm-map (kbd "C-h") 'delete-backward-char)
(define-key helm-find-files-map (kbd "C-h") 'delete-backward-char)

; Tabキーで補完を有効にする
(define-key helm-read-file-map (kbd "TAB") 'helm-execute-persistent-action)
(define-key helm-find-files-map (kbd "TAB") 'helm-execute-persistent-action)
(defadvice helm-ff-kill-or-find-buffer-fname (around execute-only-if-exist activate)
  "Execute command only if CANDIDATE exists"
  (when (file-exists-p candidate)
        ad-do-it))

;; 画面上部にhelm を出現させる
(setq helm-display-function (lambda (buf)
			      (split-window-vertically (- 16))
			      (other-window 1)
			      (switch-to-buffer buf)
			                                   ))

; キーバインド
(define-key global-map (kbd "C-x b") 'helm-for-files)
(define-key global-map (kbd "C-x C-f") 'helm-find-files)
(define-key global-map (kbd "M-x")     'helm-M-x)
(define-key global-map (kbd "M-y")     'helm-show-kill-ring)



;; company
(require 'company)
(global-company-mode)
(setq company-idle-delay 0.1)
(setq company-minimum-prefix-length 2)
(setq company-selection-wrap-around t)


(defun company--insert-candidate2 (candidate)
  (when (> (length candidate) 0)
    (setq candidate (substring-no-properties candidate))
    (if (eq (company-call-backend 'ignore-case) 'keep-prefix)
	(insert (company-strip-prefix candidate))
      (if (equal company-prefix candidate)
	  (company-select-next)
	(delete-region (- (point) (length company-prefix)) (point))
	(insert candidate))
      )))

(defun company-complete-common2 ()
  (interactive)
  (when (company-manual-begin)
    (if (and (not (cdr company-candidates))
	     (equal company-common (car company-candidates)))
	(company-complete-selection)
      (company--insert-candidate2 company-common))))

(define-key company-active-map [tab] 'company-complete-common2)
(define-key company-active-map [backtab] 'company-select-previous) ; おまけ


;; =================================================
;; company-mode company-tern
;; =================================================
(require 'js2-mode)
(add-to-list 'auto-mode-alist '("\\.js\\'" . js2-mode))

(setq company-tern-property-marker "")
(defun company-tern-depth (candidate)
  "Return depth attribute for CANDIDATE. 'nil' entries are treated as 0."
  (let ((depth (get-text-property 0 'depth candidate)))
    (if (eq depth nil) 0 depth)))

(add-hook 'js2-mode-hook
	  (lambda ()
	    (tern-mode t)))

(add-to-list 'company-backends 'company-tern)





;; =================================================
;; package: undo-tree
;; =================================================
(require 'undo-tree)
(global-undo-tree-mode t)
(global-set-key (kbd "M-/") 'undo-tree-redo)


;; ==================================================
;; tramp / ssh remote file open
;; ==================================================
(require 'tramp)
(setq tramp-default-method "ssh")
(add-to-list 'tramp-default-proxies-alist
	     '(nil "\\'root'" "/ssh:%h:"))
(add-to-list 'tramp-default-proxies-alist
	     '("localhost" nil nil))
(add-to-list 'tramp-default-proxies-alist
	     '((regexp-quote (system-name)) nil nil))



;; =================================================
;; rust-mode
;; =================================================
(require 'rust-mode)


;; =================================================
;; cc-mode 
;; =================================================
(require 'cc-mode)
(add-hook 'c-mode-common-hook
	  '(lambda ()
	    (setq c-default-style "linux") ; Linux Kernel のコーディング規約に従う
	    (setq indent-tabs-mode nil)    ; タブを利用
	    (setq c-basic-offset 4)        ; tabサイズを4にする
	    (setq tab-width 4)
	    (define-key c-mode-map (kbd "<f6>") 'man)
	    )
	  )


;; Compilation
(global-set-key (kbd "<f5>")
		(lambda ()
		  (interactive)
		  (setq-local compilation-read-command nil)
		  (call-interactively 'compile)))


;; =================================================
;; mardown-mode 
;; =================================================
(require 'markdown-mode)


;; =================================================
;; ruby-mode 
;; =================================================
(require 'ruby-mode)
(require 'robe)
(add-hook 'ruby-mode-hook (lambda()
			    (robe-mode)
			    (robe-start)
			    (push 'company-robe company-backends)
			    ))ls




;; ================================================
;; 3画面に分割するすげーやつ。
;; ===============================================
(defun split-window-vertically-n (num_wins)
  (interactive "p")
  (if (= num_wins 2)
      (split-window-vertically)
    (progn
      (split-window-vertically
       (- (window-height) (/ (window-height) num_wins)))
      (split-window-vertically-n (- num_wins 1)))))
(defun split-window-horizontally-n (num_wins)
  (interactive "p")
  (if (= num_wins 2)
      (split-window-horizontally)
    (progn
      (split-window-horizontally
       (- (window-width) (/ (window-width) num_wins)))
      (split-window-horizontally-n (- num_wins 1)))))
(global-set-key "\C-x5" '(lambda ()
			   (interactive)
			   (split-window-vertically-n 3)))
(global-set-key "\C-x4" '(lambda ()
			   (interactive)
			                              (split-window-horizontally-n 3)))

;; 起動時の画面レイアウト
(setq initial-scratch-message "")
(defun remove-scratch-buffer ()
  (if (get-buffer "*scratch*")
      (kill-buffer "*scratch*")))
(add-hook 'after-change-major-mode-hook 'remove-scratch-buffer)

(setq-default message-log-max nil)
(kill-buffer "*Messages*")

(add-hook 'after-init-hook (lambda()
			     (split-window-horizontally-n 3)
			     
			     (eshell)))
